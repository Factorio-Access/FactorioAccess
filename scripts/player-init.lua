--[[
Player Initialization Module
Handles initialization of player state when joining the game.
Sets up default values and data structures for each player.
]]

local FaUtils = require("scripts.fa-utils")
local TH = require("scripts.table-helpers")
local Localising = require("scripts.localising")
local BumpDetection = require("scripts.bump-detection")

local dirs = defines.direction

local mod = {}

---Initialize the globally saved data tables for a specific player
---@param player LuaPlayer
function mod.initialize(player)
   local force = player.force.index
   storage.forces[force] = storage.forces[force] or {}
   local fa_force = storage.forces[force]

   storage.players[player.index] = storage.players[player.index] or {}
   local faplayer = storage.players[player.index]
   faplayer.player = player

   if not fa_force.resources then
      for pi, p in pairs(storage.players) do
         if p.player.valid and p.player.force.index == force and p.resources and p.mapped then
            fa_force.resources = p.resources
            fa_force.mapped = p.mapped
            break
         end
      end
      fa_force.resources = fa_force.resources or {}
      fa_force.mapped = fa_force.mapped or {}
   end

   local character = player.cutscene_character or player.character or player
   faplayer.in_item_selector = faplayer.in_item_selector or false
   faplayer.entering_search_term = faplayer.entering_search_term or false
   faplayer.menu_search_index = faplayer.menu_search_index or nil
   faplayer.menu_search_index_2 = faplayer.menu_search_index_2 or nil
   faplayer.menu_search_term = faplayer.menu_search_term or nil
   faplayer.menu_search_frame = faplayer.menu_search_frame or nil
   faplayer.menu_search_last_name = faplayer.menu_search_last_name or nil
   faplayer.num_elements = faplayer.num_elements or 0
   faplayer.player_direction = faplayer.player_direction or character.walking_state.direction
   faplayer.position = faplayer.position or FaUtils.center_of_tile(character.position)
   faplayer.building_direction = faplayer.building_direction or dirs.north --top

   if type(faplayer.building_footprint) == "number" then faplayer.building_footprint = nil end

   if type(faplayer.building_dir_arrow) == "number" then faplayer.building_dir_arrow = nil end

   faplayer.overhead_sprite = nil
   faplayer.overhead_circle = nil
   faplayer.custom_GUI_frame = nil
   faplayer.custom_GUI_sprite = nil
   faplayer.direction_lag = faplayer.direction_lag or true
   faplayer.previous_hand_item_name = faplayer.previous_hand_item_name or ""
   faplayer.last = faplayer.last or ""
   faplayer.last_indexed_ent = faplayer.last_indexed_ent or nil
   faplayer.item_selection = faplayer.item_selection or false
   faplayer.item_cache = faplayer.item_cache or {}
   faplayer.zoom = faplayer.zoom or 1
   faplayer.last_move_tick = faplayer.last_move_tick or 0
   faplayer.last_build_tick = faplayer.last_build_tick or 0
   faplayer.last_click_tick = faplayer.last_click_tick or 0
   faplayer.last_menu_search_tick = faplayer.last_menu_search_tick or 0
   faplayer.last_pickup_tick = faplayer.last_pickup_tick or 0
   faplayer.last_menu_toggle_tick = faplayer.last_menu_toggle_tick or 0
   faplayer.last_damage_alert_tick = faplayer.last_damage_alert_tick or 0
   faplayer.last_honk_tick = faplayer.last_honk_tick or 0
   faplayer.last_driving_alert_tick = faplayer.last_driving_alert_tick or 0
   faplayer.last_click_time = faplayer.last_click_time or 0
   faplayer.lag_building_in_hand = faplayer.lag_building_in_hand or nil
   faplayer.lag_building_selected = faplayer.lag_building_selected or nil
   faplayer.tile = faplayer.tile or character.surface.get_tile(character.position.x, character.position.y)
   faplayer.move_state = faplayer.move_state or {}
   faplayer.remote_view = faplayer.remote_view or false
   faplayer.remote_view_tiles = faplayer.remote_view_tiles or 0
   faplayer.cursor_size = faplayer.cursor_size or 0
   faplayer.ruler = faplayer.ruler or nil
   faplayer.build_lock = faplayer.build_lock or false
   faplayer.inventory = faplayer.inventory
      or {
         lua_inventory = character.get_main_inventory(),
         index = 1,
         width = 10,
         max = #character.get_main_inventory(),
      }
   faplayer.crafting = faplayer.crafting
      or {
         lua_recipes = {},
         max = 1,
         index = 1,
         category = 1,
      }
   faplayer.crafting_queue = faplayer.crafting_queue or { index = 1, max = 0 }
   faplayer.blueprint_hand = faplayer.blueprint_hand or {}
   faplayer.blueprint_reselect = faplayer.blueprint_reselect or { bp = nil, from_inv = nil }

   faplayer.building = faplayer.building
      or {
         ent = nil,
         recipe_list = nil,
         recipe_selection = false,
         index = 1,
         sector = 1,
         item_selection = false,
         sectors = {},
         sector_name = "",
      }
   faplayer.building.sectors = faplayer.building.sectors or {} --laterdo maybe remove this, it might be redundant

   faplayer.mining = faplayer.mining or {}

   faplayer.repair = faplayer.repair or {}

   faplayer.warnings = faplayer.warnings or {}

   faplayer.walking = faplayer.walking or {}

   faplayer.combat = faplayer.combat or {}

   faplayer.rail_builder = faplayer.rail_builder or nil

   faplayer.menu_history = faplayer.menu_history or {}

   faplayer.menu = faplayer.menu or "character"

   faplayer.move_queue = faplayer.move_queue or {}

   faplayer.travel_queue_list = faplayer.travel_queue_list or {}

   faplayer.spidertron_remote = faplayer.spidertron_remote or { active = false, spider = nil }

   faplayer.item_selector = faplayer.item_selector or { index = 1, group = 0, subgroup = 0 }

   faplayer.equipment = faplayer.equipment or { index = 1, sector = 1 }

   faplayer.technology = faplayer.technology or { category = 1, index = 1 }

   faplayer.belt_lane_direction = faplayer.belt_lane_direction or nil

   faplayer.belt_side = faplayer.belt_side or nil

   faplayer.bp_selecting = faplayer.bp_selecting or false

   faplayer.bp_select_start_pos = faplayer.bp_select_start_pos or nil

   --Clear the temporary selection table
   if faplayer.selection then
      faplayer.selection.starting = nil
      faplayer.selection.ending = nil
   end

   faplayer.network_or_logistics = faplayer.network_or_logistics or "logistics"

   faplayer.circuit_network_menu = faplayer.circuit_network_menu
      or {
         network_index = nil,
         signal_index = nil,
         signal_name = nil,
         index = 1,
      }

   faplayer.skip_read_hand_on_cursor_stack_changed = faplayer.skip_read_hand_on_cursor_stack_changed or false

   faplayer.opened_inventory = faplayer.opened_inventory or nil

   --Quickbar
   faplayer.qb_index = faplayer.qb_index or 1
   faplayer.qb_slot = faplayer.qb_slot or { 1, 1 }
   faplayer.qb_page_count = faplayer.qb_page_count or 0

   --Key help
   faplayer.key_help_mode = faplayer.key_help_mode or false

   -- Mouse
   faplayer.is_selecting = faplayer.is_selecting or false

   -- Graphics and rendering
   faplayer.building_footprint = faplayer.building_footprint or nil
   faplayer.building_footprint_clear = faplayer.building_footprint_clear or nil
   faplayer.building_footprint_valid = faplayer.building_footprint_valid or true
   faplayer.building_footprint_size = faplayer.building_footprint_size or nil
   faplayer.building_dir_arrow = faplayer.building_dir_arrow or nil
   faplayer.cursor_horiz = faplayer.cursor_horiz or nil
   faplayer.cursor_verti = faplayer.cursor_verti or nil
   faplayer.cursor_round = faplayer.cursor_round or nil
   faplayer.vanilla_mode = faplayer.vanilla_mode or false
   faplayer.draw_cursor = faplayer.draw_cursor or false
   faplayer.hide_cursor = faplayer.hide_cursor or false
   faplayer.hide_line = faplayer.hide_line or false
   faplayer.hide_line_ticks = faplayer.hide_line_ticks or 0
   faplayer.draw_direction_keys_lines = faplayer.draw_direction_keys_lines or false
   faplayer.draw_1_narrow_line = faplayer.draw_1_narrow_line or false
   faplayer.draw_1_narrow_line_tick = faplayer.draw_1_narrow_line_tick or 0
   faplayer.hide_arrow = faplayer.hide_arrow or false
   faplayer.hide_arrow_ticks = faplayer.hide_arrow_ticks or 0
   faplayer.hide_footprint = faplayer.hide_footprint or false
   faplayer.hide_footprint_ticks = faplayer.hide_footprint_ticks or 0
   faplayer.hide_inv_slots = faplayer.hide_inv_slots or false
   faplayer.hide_inv_slot_ticks = faplayer.hide_inv_slot_ticks or 0
   faplayer.hide_bp = faplayer.hide_bp or false
   faplayer.hide_bp_ticks = faplayer.hide_bp_ticks or 0
   faplayer.inv_index_announcement = faplayer.inv_index_announcement or "none"
   faplayer.inv_mode_announcement = faplayer.inv_mode_announcement or "standard"
   faplayer.jump_to_text_field = faplayer.jump_to_text_field or false
   faplayer.old_drawing = faplayer.old_drawing or false
   faplayer.click_to_text_field = faplayer.click_to_text_field or false
   faplayer.draw_cursor_index = faplayer.draw_cursor_index or false
   faplayer.draw_cursor_original_index = faplayer.draw_cursor_original_index or false

   -- Player preferences
   faplayer.preferences = faplayer.preferences or {}

   faplayer.preferences.building_inventory_row_length = faplayer.preferences.building_inventory_row_length or 8
   if faplayer.preferences.inventory_wraps_around == nil then faplayer.preferences.inventory_wraps_around = true end
   if faplayer.preferences.tiles_placed_from_northwest_corner == nil then
      faplayer.preferences.tiles_placed_from_northwest_corner = false
   end

   -- Walking modes
   faplayer.smooth_walking = faplayer.smooth_walking or true

   -- Logistic and trash slots
   faplayer.logistic_slot_counts = faplayer.logistic_slot_counts or {}
   if not (player.character == nil) then faplayer.logistic_slot_counts = faplayer.logistic_slot_counts or {} end
   faplayer.trash_slot_count = faplayer.trash_slot_count or 0
   -- TODO: request_slot_count doesn't exist on LuaEntity - this was added in the refactoring
   -- if not (player.character == nil) then faplayer.trash_slot_count = player.character.request_slot_count end

   -- Other
   faplayer.last_aggregate = faplayer.last_aggregate or {}
   faplayer.recent_item_name = faplayer.recent_item_name or ""
   faplayer.recent_fluid_name = faplayer.recent_fluid_name or ""
   faplayer.last_line_id = faplayer.last_line_id or 0
   faplayer.tutorial_mode = faplayer.tutorial_mode or false
   faplayer.launcher_version = faplayer.launcher_version or "0.0.0"
   faplayer.in_splash_sequence = faplayer.in_splash_sequence or false
   faplayer.play_cursor_sound = faplayer.play_cursor_sound or false
   faplayer.resources = fa_force.resources or {}
   faplayer.mapped = fa_force.mapped or {}
   faplayer.following = faplayer.following or nil
   faplayer.followed_by = faplayer.followed_by or {}
   faplayer.follow_id = faplayer.follow_id or nil
   faplayer.last_technology_count = faplayer.last_technology_count or 0
   faplayer.click_to_open = faplayer.click_to_open or "disabled"
   faplayer.entering_new_character_name = faplayer.entering_new_character_name or false
   faplayer.renaming_character_name = faplayer.renaming_character_name or ""
   faplayer.confirm_action_tick = faplayer.confirm_action_tick or 0
   faplayer.idle_action_todo = faplayer.idle_action_todo or ""
   faplayer.idle_action_save = faplayer.idle_action_save or nil
   faplayer.last_running_direction = faplayer.last_running_direction or dirs.north
   faplayer.lag_voice_queued = faplayer.lag_voice_queued or false
   faplayer.cursor_scanned = faplayer.cursor_scanned or false
   faplayer.warned_heavily_forested = faplayer.warned_heavily_forested or false
   faplayer.warned_mining_near_pipe = faplayer.warned_mining_near_pipe or false
   faplayer.warned_pipe_on_ground = faplayer.warned_pipe_on_ground or false
   faplayer.last_30_tile = faplayer.last_30_tile or ""
   faplayer.last_20_tile = faplayer.last_20_tile or ""
   faplayer.last_10_tile = faplayer.last_10_tile or ""
   faplayer.time_of_30 = faplayer.time_of_30 or 0
   faplayer.time_of_20 = faplayer.time_of_20 or 0
   faplayer.time_of_10 = faplayer.time_of_10 or 0
   faplayer.last_60_ent = faplayer.last_60_ent or ""
   faplayer.last_40_ent = faplayer.last_40_ent or ""
   faplayer.last_20_ent = faplayer.last_20_ent or ""
   faplayer.time_of_ent_60 = faplayer.time_of_ent_60 or 0
   faplayer.time_of_ent_40 = faplayer.time_of_ent_40 or 0
   faplayer.time_of_ent_20 = faplayer.time_of_ent_20 or 0
   faplayer.last_60_tree = faplayer.last_60_tree or ""
   faplayer.last_40_tree = faplayer.last_40_tree or ""
   faplayer.last_20_tree = faplayer.last_20_tree or ""
   faplayer.time_of_tree_60 = faplayer.time_of_tree_60 or 0
   faplayer.time_of_tree_40 = faplayer.time_of_tree_40 or 0
   faplayer.time_of_tree_20 = faplayer.time_of_tree_20 or 0
   faplayer.last_obstacle_tick = faplayer.last_obstacle_tick or 0
   faplayer.last_warned_pos = faplayer.last_warned_pos or { x = 0, y = 0 }
   faplayer.cursor_bookmark_direction = faplayer.cursor_bookmark_direction or dirs.north
   faplayer.entities_scanned = faplayer.entities_scanned or {}
   faplayer.players_distance_described = faplayer.players_distance_described or false
   faplayer.quick_bar_rows = faplayer.quick_bar_rows or 1
   -- TODO: mod_settings doesn't exist on LuaEntity - should use player.mod_settings instead
   -- if not (player.character == nil) then
   --    local quickbar_setting = player.mod_settings["fa-quickbar-rows"]
   --    if quickbar_setting then
   --       faplayer.quick_bar_rows = quickbar_setting.value
   --    end
   -- end
   faplayer.said_owner = faplayer.said_owner or {}

   -- Menu initializations
   faplayer.train_menu = faplayer.train_menu
      or {
         index = 0,
         renaming = false,
         locomotive = nil,
         wait_time = 300,
         index_2 = 0,
         selecting_station = false,
      }

   faplayer.spider_menu = faplayer.spider_menu or {
      index = 0,
      renaming = false,
      spider = nil,
   }

   faplayer.train_stop_menu = faplayer.train_stop_menu
      or {
         index = 0,
         renaming = false,
         stop = nil,
         wait_condition = "time",
         wait_time_seconds = 30,
         safety_wait_enabled = true,
      }

   faplayer.valid_train_stop_list = faplayer.valid_train_stop_list or {}

   faplayer.roboport_menu = faplayer.roboport_menu or {
      port = nil,
      index = 0,
      renaming = false,
   }

   faplayer.blueprint_menu = faplayer.blueprint_menu
      or {
         index = 0,
         edit_label = false,
         edit_description = false,
         edit_export = false,
         edit_import = false,
      }

   faplayer.blueprint_book_menu = faplayer.blueprint_book_menu
      or {
         index = 0,
         menu_length = 0,
         list_mode = true,
         edit_label = false,
         edit_description = false,
         edit_export = false,
         edit_import = false,
      }

   faplayer.pump = faplayer.pump or {
      index = 0,
      positions = {},
   }

   -- Force rechart on empty map
   if table_size(faplayer.mapped) == 0 then player.force.rechart() end

   faplayer.localisations = faplayer.localisations or {}
   faplayer.translation_id_lookup = faplayer.translation_id_lookup or {}
   Localising.check_player(player.index)

   -- Initialize bump detection
   BumpDetection.reset_bump_stats(player.index)
end

return mod
